# Analytics Collection

## Mongoose Model Reference
- **Model File**: Analytic.ts (singular)
- **Model Class**: Analytic (singular)
- **Collection**: analytics (auto-generated by Mongoose)


## Purpose

User behavior analytics with automatic cleanup for comprehensive tracking of platform usage, story engagement, and user interactions while managing storage efficiency through TTL-based data retention.

## Schema

```javascript
{
  _id: ObjectId,
  eventType: String,          // 'story_start' | 'story_complete' | 'choice' | 'achievement_unlock' | 'story_view' | 'user_action'
  userId: ObjectId,           // can be null for anonymous users
  storyId: ObjectId,          // null for non-story events
  nodeId: String,             // for choice and navigation events (null for others)
  choiceId: String,           // for choice events (null for others)

  // Event-specific metadata
  metadata: {
    timeSpent: Number,        // time spent on node/story in milliseconds
    pathTaken: [String],      // sequence of node IDs for story completion
    endingType: String,       // 'good' | 'bad' | 'neutral' | 'secret' (for story completion)
    deviceType: String,       // 'mobile' | 'desktop' | 'tablet'
    sessionId: String,        // user session identifier
    referrer: String,         // traffic source
    userAgent: String,        // browser/device information
    language: String,         // user language preference
    storyProgress: Number,    // percentage through story (0-100)
    userLevel: Number,        // user experience level
    choiceContext: Object,    // additional context for choices
    achievementDetails: Object, // details for achievement unlocks
    customProperties: Object  // flexible additional event data
  },

  // Geographic and technical data
  geography: {
    country: String,          // user country (ISO code)
    city: String,             // user city (optional)
    timezone: String          // user timezone
  },

  // Performance metrics
  performance: {
    loadTime: Number,         // page load time in milliseconds
    responseTime: Number,     // API response time
    errorCount: Number,       // number of errors during event
    networkType: String       // 'wifi' | 'cellular' | 'ethernet'
  },

  // Timestamps
  timestamp: Date,            // when the event occurred
  createdAt: Date,            // document creation time
  processedAt: Date           // when analytics were processed
}
```

## Key Features

- **Comprehensive Tracking**: Covers all major user interactions and platform events
- **Flexible Schema**: Extensible metadata for different event types
- **Automatic Cleanup**: TTL-based data retention for storage efficiency
- **Performance Monitoring**: Built-in performance metrics collection
- **Geographic Intelligence**: Location-based analytics and insights
- **Privacy Compliant**: Anonymous user tracking with optional user identification

## Event Types

### Story Events
- **story_start**: User begins reading a story
- **story_complete**: User finishes a story
- **story_view**: User views story details or preview
- **story_abandon**: User stops reading before completion

### Interaction Events
- **choice**: User makes a story choice
- **node_view**: User views a specific story node
- **achievement_unlock**: User unlocks an achievement
- **level_up**: User advances to next level

### User Actions
- **user_register**: New user registration
- **user_login**: User login event
- **user_logout**: User logout event
- **profile_update**: User updates profile information

### System Events
- **app_start**: Application launch
- **feature_usage**: Usage of specific features
- **error_occurred**: Application errors
- **performance_issue**: Performance degradation events

## Metadata Schema by Event Type

### Story Start Event
```javascript
{
  timeSpent: 0,
  deviceType: "mobile",
  sessionId: "session_123",
  referrer: "direct",
  userAgent: "Mozilla/5.0...",
  storyProgress: 0,
  userLevel: 5
}
```

### Choice Event
```javascript
{
  timeSpent: 45000,           // 45 seconds on current node
  choiceContext: {
    choiceText: "Follow the mysterious path",
    choiceIndex: 2,
    totalChoices: 4,
    previousNodeId: "node_123",
    nextNodeId: "node_456"
  },
  sessionId: "session_123",
  storyProgress: 25
}
```

### Story Complete Event
```javascript
{
  timeSpent: 3600000,         // Total time in milliseconds (1 hour)
  pathTaken: ["node_1", "node_2", "node_5", "node_8"],
  endingType: "good",
  choicesMade: 15,
  nodesVisited: 20,
  sessionId: "session_123",
  storyProgress: 100
}
```

### Achievement Unlock Event
```javascript
{
  achievementDetails: {
    achievementId: "story_master",
    category: "story",
    rarity: "legendary",
    pointsAwarded: 100
  },
  userLevel: 10,
  sessionId: "session_123"
}
```

## Key Indexes

```javascript
// Event type and time-based queries - analytics dashboards
db.Analytics.createIndex({ eventType: 1, timestamp: -1 });

// User-specific analytics - individual user behavior
db.Analytics.createIndex({ userId: 1, timestamp: -1 });

// Story-specific analytics - content performance
db.Analytics.createIndex({ storyId: 1, timestamp: -1 });

// Session tracking - user session analysis
db.Analytics.createIndex({ "metadata.sessionId": 1 });

// TTL for automatic cleanup - 90 days retention
db.Analytics.createIndex({ timestamp: 1 }, { expireAfterSeconds: 7776000 }); // 90 days

// Geographic analytics - location-based insights
db.Analytics.createIndex({ "geography.country": 1, timestamp: -1 });

// Performance monitoring - system health metrics
db.Analytics.createIndex({ "performance.loadTime": 1 });

// Aggregation queries - complex analytics processing
db.Analytics.createIndex({ eventType: 1, storyId: 1, userId: 1 });
```

## Query Examples

### Get story engagement metrics
```javascript
db.Analytics.aggregate([
  { $match: {
    storyId: ObjectId("story_id"),
    timestamp: { $gte: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000) } // last 30 days
  }},
  { $group: {
    _id: "$eventType",
    count: { $sum: 1 },
    uniqueUsers: { $addToSet: "$userId" },
    avgTimeSpent: { $avg: "$metadata.timeSpent" }
  }},
  { $sort: { count: -1 } }
]);
```

### Get user behavior timeline
```javascript
db.Analytics.find({
  userId: ObjectId("user_id"),
  timestamp: { $gte: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000) } // last 7 days
})
  .sort({ timestamp: -1 })
  .select({
    eventType: 1,
    storyId: 1,
    metadata: 1,
    timestamp: 1
  });
```

### Get story completion rate
```javascript
db.Analytics.aggregate([
  { $match: {
    eventType: { $in: ["story_start", "story_complete"] },
    storyId: ObjectId("story_id"),
    timestamp: { $gte: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000) }
  }},
  { $group: {
    _id: "$eventType",
    uniqueUsers: { $addToSet: "$userId" },
    count: { $sum: 1 }
  }},
  { $group: {
    _id: null,
    starts: { $sum: { $cond: [{ $eq: ["$_id", "story_start"] }, "$count", 0] } },
    completions: { $sum: { $cond: [{ $eq: ["$_id", "story_complete"] }, "$count", 0] } },
    uniqueStarters: { $sum: { $cond: [{ $eq: ["$_id", "story_start"] }, { $size: "$uniqueUsers" }, 0] } },
    uniqueCompleters: { $sum: { $cond: [{ $eq: ["$_id", "story_complete"] }, { $size: "$uniqueUsers" }, 0] } }
  }},
  { $project: {
    completionRate: { $multiply: [{ $divide: ["$completions", "$starts"] }, 100] },
    uniqueCompletionRate: { $multiply: [{ $divide: ["$uniqueCompleters", "$uniqueStarters"] }, 100] },
    totalStarts: "$starts",
    totalCompletions: "$completions"
  }}
]);
```

### Get popular story paths
```javascript
db.Analytics.aggregate([
  { $match: {
    eventType: "story_complete",
    "metadata.pathTaken": { $exists: true },
    timestamp: { $gte: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000) }
  }},
  { $unwind: "$metadata.pathTaken" },
  { $group: {
    _id: "$metadata.pathTaken",
    usageCount: { $sum: 1 },
    uniqueUsers: { $addToSet: "$userId" },
    avgCompletionTime: { $avg: "$metadata.timeSpent" }
  }},
  { $match: { usageCount: { $gte: 10 } } }, // Popular paths only
  { $sort: { usageCount: -1 } },
  { $limit: 20 }
]);
```

### Get device usage statistics
```javascript
db.Analytics.aggregate([
  { $match: {
    timestamp: { $gte: new Date(Date.now() - 24 * 60 * 60 * 1000) } // last 24 hours
  }},
  { $group: {
    _id: "$metadata.deviceType",
    totalEvents: { $sum: 1 },
    uniqueUsers: { $addToSet: "$userId" },
    eventTypes: { $addToSet: "$eventType" }
  }},
  { $sort: { totalEvents: -1 } }
]);
```

### Get geographic user distribution
```javascript
db.Analytics.aggregate([
  { $match: {
    "geography.country": { $exists: true },
    timestamp: { $gte: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000) } // last 7 days
  }},
  { $group: {
    _id: "$geography.country",
    totalEvents: { $sum: 1 },
    uniqueUsers: { $addToSet: "$userId" },
    popularEventTypes: {
      $push: { eventType: "$eventType", count: { $sum: 1 } }
    }
  }},
  { $sort: { totalEvents: -1 } }
]);
```

### Create analytics event
```javascript
const createAnalyticsEvent = (eventType, data) => {
  const event = {
    eventType: eventType,
    userId: data.userId || null,
    storyId: data.storyId || null,
    nodeId: data.nodeId || null,
    choiceId: data.choiceId || null,
    metadata: {
      ...data.metadata,
      sessionId: data.sessionId,
      userAgent: data.userAgent,
      deviceType: parseDeviceType(data.userAgent)
    },
    geography: data.geography || {},
    performance: data.performance || {},
    timestamp: new Date(),
    createdAt: new Date(),
    processedAt: new Date()
  };

  return db.Analytics.create(event);
};
```

### Get real-time analytics dashboard
```javascript
const getRealTimeMetrics = async () => {
  const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);

  const [activeUsers, storyActivity, systemHealth] = await Promise.all([
    // Active users in last hour
    db.Analytics.aggregate([
      { $match: { timestamp: { $gte: oneHourAgo } } },
      { $group: { _id: null, uniqueUsers: { $addToSet: "$userId" } } },
      { $project: { activeUsers: { $size: "$uniqueUsers" } } }
    ]),

    // Story activity
    db.Analytics.aggregate([
      { $match: {
        timestamp: { $gte: oneHourAgo },
        eventType: { $in: ["story_start", "story_complete", "choice"] }
      }},
      { $group: {
        _id: "$eventType",
        count: { $sum: 1 }
      }},
      { $group: {
        _id: null,
        storyStarts: { $sum: { $cond: [{ $eq: ["$_id", "story_start"] }, "$count", 0] } },
        storyCompletions: { $sum: { $cond: [{ $eq: ["$_id", "story_complete"] }, "$count", 0] } },
        totalChoices: { $sum: { $cond: [{ $eq: ["$_id", "choice"] }, "$count", 0] } }
      }}
    ]),

    // System health metrics
    db.Analytics.aggregate([
      { $match: {
        timestamp: { $gte: oneHourAgo },
        "performance.loadTime": { $exists: true }
      }},
      { $group: {
        _id: null,
        avgLoadTime: { $avg: "$performance.loadTime" },
        avgResponseTime: { $avg: "$performance.responseTime" },
        totalErrors: { $sum: "$performance.errorCount" }
      }}
    ])
  ]);

  return {
    timestamp: new Date(),
    activeUsers: activeUsers[0]?.activeUsers || 0,
    storyActivity: storyActivity[0] || {},
    systemHealth: systemHealth[0] || {}
  };
};
```

## Data Processing and Aggregation

### Batch Processing for Reports
```javascript
const generateDailyReport = async (date) => {
  const startOfDay = new Date(date);
  startOfDay.setHours(0, 0, 0, 0);

  const endOfDay = new Date(date);
  endOfDay.setHours(23, 59, 59, 999);

  const dailyReport = await db.Analytics.aggregate([
    { $match: {
      timestamp: { $gte: startOfDay, $lte: endOfDay }
    }},
    { $group: {
      _id: {
        eventType: "$eventType",
        hour: { $hour: "$timestamp" }
      },
      count: { $sum: 1 },
      uniqueUsers: { $addToSet: "$userId" },
      avgTimeSpent: { $avg: "$metadata.timeSpent" }
    }},
    { $group: {
      _id: "$_id.eventType",
      hourlyBreakdown: {
        $push: {
          hour: "$_id.hour",
          count: "$count",
          uniqueUsers: { $size: "$uniqueUsers" }
        }
      },
      totalCount: { $sum: "$count" },
      totalUniqueUsers: { $sum: { $size: "$uniqueUsers" } },
      avgTimeSpent: { $avg: "$avgTimeSpent" }
    }},
    { $sort: { totalCount: -1 } }
  ]);

  return {
    date: date.toISOString().split('T')[0],
    report: dailyReport,
    generatedAt: new Date()
  };
};
```

## Integration Points

### Users Collection
- Link analytics events to user accounts
- Track user behavior patterns
- Personalization based on analytics

### Stories Collection
- Update story performance metrics
- Track story popularity and engagement
- Content recommendation algorithms

### SystemConfig Collection
- Feature flag usage analytics
- A/B testing data collection
- Performance impact measurement

### SecurityEvents Collection
- Correlate suspicious activity with analytics
- Threat detection through behavior analysis
- Anomaly detection in user patterns

## Performance Optimization

- **TTL Indexes**: Automatic cleanup of old data
- **Efficient Indexing**: Optimized for common analytical queries
- **Batch Processing**: Aggregate data processing for reports
- **Memory Management**: Prevent unbounded collection growth

## Privacy and Compliance

### Data Anonymization
- Anonymous user tracking options
- IP address anonymization capabilities
- PII filtering and masking
- GDPR compliance features

### User Consent
- Configurable tracking levels
- Opt-out mechanisms
- Data retention controls
- User data export capabilities

## Analytics Applications

### Business Intelligence
- User engagement metrics
- Content performance analysis
- Geographic usage patterns
- Device usage statistics

### Product Optimization
- Feature usage analysis
- User journey mapping
- Performance bottleneck identification
- Conversion funnel analysis

### Content Strategy
- Popular story identification
- User preference analysis
- Content gap identification
- Personalization data

---

*Last updated: December 2024*