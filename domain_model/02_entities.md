# Domain Model Specification (Stage 2) - Part 2: Domain Entities

## 2. DOMAIN ENTITIES

## Entity: User (ผู้ใช้)
- **Description**: ผู้เล่นที่ลงทะเบียนแล้วมีข้อมูลบัญชีถาวร กระเป๋าเครดิต ความสำเร็จ และฟีเจอร์สังคม
- **Primary Identifier**: userId (UUID)
- **Attributes**:
  - email (string, unique) - อีเมลผู้ใช้
  - passwordHash (string) - รหัสผ่านเข้ารหัส
  - username (string, unique) - ชื่อที่แสดง
  - avatarId (string, foreign key) - อวาตาร์ที่ใช้อยู่
  - bio (text, 500 chars) - คำอธิบายโปรไฟล์
  - isEmailVerified (boolean) - สถานะการยืนยันอีเมล
  - registrationDate (datetime) - วันที่สร้างบัญชี
  - lastLoginDate (datetime) - การเข้าสู่ระบบครั้งล่าสุด
  - isActive (boolean) - สถานะบัญชี
  - preferences (json) - การตั้งค่าและความชอบของผู้ใช้
- **Computed Attributes**:
  - totalPlaytime (duration) - ผลรวมเวลาที่จบเรื่องทั้งหมด
  - completionRate (percentage) - เรื่องที่จบเทียบกับเรื่องที่เริ่ม
  - totalCreditsEarned (integer) - ยอดเครดิตสะสมตลอดชีวิต
  - achievementProgress (percentage) - ความสำเร็จที่ปลดล็อกเทียบกับทั้งหมด
- **Relationships**:
  - One-to-Many: CreditWallet, UserAchievement, StoryProgress, Rating, Review
  - Many-to-Many: Friends (self-referential)
- **Visibility Rules**: ข้อมูลส่วนตัวทั้งหมดซ่อนจากผู้ใช้อื่น; เฉพาะ username, avatar, bio และความสำเร็จที่แสดงสาธารณะ
- **Invariants**:
  - อีเมลต้องไม่ซ้ำและยืนยันเพื่อการเข้าถึงบัญชีเต็ม
  - username ต้องไม่ซ้ำและไม่ว่างเปล่า
  - รหัสผ่านต้องเป็นไปตามข้อกำหนดความปลอดภัย
- **Lifecycle**: Pending (unverified) → Active → Suspended → Deleted

## Entity: GuestUser (ผู้ใช้ผู้มาเยือน)
- **Description**: ผู้เล่นชั่วคราวตามเซสชันที่มีฟีเจอร์จำกัดและการเก็บข้อมูลตามเซสชัน
- **Primary Identifier**: guestSessionId (UUID)
- **Attributes**:
  - sessionStartDate (datetime) - วันที่สร้างเซสชัน
  - lastActivityDate (datetime) - การโต้ตอบครั้งล่าสุด
  - temporaryProgress (json) - ความคืบหน้าเรื่องเฉพาะเซสชัน
  - temporaryAchievements (array) - ความสำเร็จเฉพาะเซสชัน (ไม่บันทึก)
- **Computed Attributes**:
  - sessionDuration (duration) - เวลานับจากเริ่มเซสชัน
  - sessionPlaytime (duration) - เวลาที่ใช้ในเรื่องระหว่างเซสชัน
- **Relationships**:
  - One-to-One: TemporaryCreditWallet (session-based)
- **Visibility Rules**: ข้อมูลทั้งหมดเฉพาะเซสชัน มองไม่เห็นสำหรับผู้ใช้อื่น
- **Invariants**:
  - เครดิตจำกัดสูงสุด 50
  - ไม่มีการจัดเก็บข้อมูลถาวร
  - เซสชันหมดอายุหลังไม่มีการใช้งาน 24 ชั่วโมง
- **Lifecycle**: Created → Active → Expired/Converted

## Entity: Story (เรื่องราว)
- **Description**: เรื่องเล่าสนทนาที่มีฉากแยกเส้นทาง เนื้อหามัลติมีเดีย และจุดสิ้นสุดหลายแบบ
- **Primary Identifier**: storyId (UUID)
- **Attributes**:
  - title (string, 100 chars) - ชื่อเรื่อง
  - description (text, 1000 chars) - เรื่องย่อ
  - authorId (UUID, foreign key) - ID ผู้สร้าง
  - genre (enum) - หมวดหมู่เรื่อง (romance, horror, adventure, mystery, fantasy)
  - tags (array of strings) - แท็กเนื้อหาสำหรับกรอง
  - language (string) - ภาษาเนื้อหา (default: Thai)
  - estimatedPlaytime (integer, minutes) - เวลาที่ใช้จบโดยเฉลี่ย
  - difficulty (enum) - ความซับซ้อนเรื่อง (easy, medium, hard)
  - state (enum) - สถานะการเผยแพร่ (draft, ready, published, archived)
  - creationDate (datetime) - วันที่สร้างเรื่อง
  - publishDate (datetime) - วันที่เผยแพร่
  - lastUpdated (datetime) - การแก้ไขครั้งล่าสุด
  - version (integer) - หมายเลขเวอร์ชันเรื่อง
  - thumbnailImageId (UUID, foreign key) - อ้างอิงภาพปก
  - isPremium (boolean) - สถานะเนื้อหาพรีเมียม
  - requiredAchievementId (UUID, foreign key, nullable) - ข้อกำหนดความสำเร็จสำหรับการเข้าถึง
- **Computed Attributes**:
  - averageRating (decimal, 2 decimal places) - คะแนนเฉลี่ยผู้ใช้
  - totalRatings (integer) - จำนวนการจัดอันดับที่ได้รับ
  - totalReviews (integer) - จำนวนรีวิวที่เขียน
  - completionRate (percentage) - สถิติการจบเรื่องทั่วไป
  - totalPlays (integer) - จำนวนครั้งที่เริ่มเรื่อง
  - averageCompletionTime (duration) - เวลาที่ใช้จบโดยเฉลี่ย
- **Relationships**:
  - Many-to-One: User (author)
  - One-to-Many: Scene, Rating, Review, StoryProgress
  - Many-to-Many: Asset
- **Visibility Rules**: เรื่องฉบับร่างมองเห็นได้เฉพาะผู้เขียนและผู้ดูแลระบบ; เรื่องที่เผยแพร่มองเห็นได้ทุกผู้ใช้
- **Invariants**:
  - ต้องมีอย่างน้อยหนึ่งฉาก
  - เรื่องที่เผยแพร่ต้องมีโครงสร้างที่ถูกต้อง (ไม่มี node กำกวม)
  - ชื่อเรื่องและคำอธิบายจำเป็นสำหรับการเผยแพร่
- **Lifecycle**: Draft → Ready → Published → Archived

## Entity: Scene (ฉาก)
- **Description**: ส่วนของเรื่องแต่ละส่วนที่มีเนื้อหามัลติมีเดียและตัวเลือกที่มี
- **Primary Identifier**: sceneId (UUID)
- **Attributes**:
  - storyId (UUID, foreign key) - อ้างอิงเรื่องแม่
  - title (string, 100 chars) - ชื่อฉาก
  - description (text) - เนื้อหา/ข้อความเล่าเรื่องของฉาก
  - orderIndex (integer) - ลำดับฉากในกระแสเรื่อง
  - sceneType (enum) - หมวดหมู่ฉาก (intro, normal, choice, ending)
  - backgroundVideoUrl (string, nullable) - URL วิดีโอพื้นหลัง
  - backgroundImageId (UUID, foreign key, nullable) - อ้างอิงภาพพื้นหลัง
  - backgroundMusicUrl (string, nullable) - URL เสียงพื้นหลัง
  - textSegments (array) - ส่วนข้อความซ้อนที่มีเวลา
  - timingData (json) - การกำหนดค่าเวลาของส่วน
  - autoAdvanceDelay (integer, seconds) - ความล่าช้าก่อนส่วนถัดไป
  - isEnding (boolean) - สถานะจุดสิ้นสุดเรื่อง
  - endingType (enum, nullable) - หมวดหมู่จุดสิ้นสุด (normal, special, perfect)
  - isEntryPoint (boolean) - สามารถเข้าถึงโดยตรงได้
  - coordinates (json) - ตำแหน่งในการแสดงภาพเครื่องมือแก้ไขเรื่อง
- **Computed Attributes**:
  - totalDuration (duration) - ผลรวมระยะเวลาของส่วนทั้งหมด
  - choiceCount (integer) - จำนวนตัวเลือกที่มี
  - visitRate (percentage) - ความถี่ที่ถึงฉากนี้
  - averageTimeSpent (duration) - เวลาที่ผู้ใช้ใช้ในฉาก
- **Relationships**:
  - Many-to-One: Story
  - One-to-Many: Choice
  - Many-to-Many: Asset
- **Visibility Rules**: เนื้อหาฉากมองเห็นได้เฉพาะระหว่างการเล่นเรื่อง; โครงสร้างมองเห็นได้สำหรับผู้ดูแลระบบและผู้เขียน
- **Invariants**:
  - ทุกฉากต้องมีตัวเลือกขาออกอย่างน้อยหนึ่งตัว (ยกเว้นจุดสิ้นสุด)
  - ฉากจุดสิ้นสุดต้องมี isEnding = true
  - ส่วนข้อความต้องมีข้อมูลเวลาที่ถูกต้อง
- **Lifecycle**: Created → Connected → Validated → Published

## Entity: Choice (ตัวเลือก)
- **Description**: ตัวเลือกแยกเส้นทางที่เชื่อมต่อฉากพร้อมค่าใช้จ่ายและข้อกำหนดที่เกี่ยวข้อง
- **Primary Identifier**: choiceId (UUID)
- **Attributes**:
  - fromSceneId (UUID, foreign key) - ฉากต้นทาง
  - toSceneId (UUID, foreign key) - ฉากปลายทาง
  - displayText (string, 200 chars) - ข้อความปุ่มตัวเลือก
  - description (text, nullable) - คำอธิบายเมื่อชี้
  - creditCost (integer) - เครดิตที่จำเป็นต้องใช้ในการเลือก
  - requiredAchievementId (UUID, foreign key, nullable) - ข้อกำหนดความสำเร็จ
  - isSpecialChoice (boolean) - สถานะตัวเลือกพรีเมียม
  - choiceOutcome (enum) - หมวดหมู่ผลลัพธ์ (positive, negative, neutral)
  - condition (json, nullable) - เงื่อนไขการปลดล็อกที่ซับซ้อน
  - probability (decimal, nullable) - ความน่าจะเป็นในการเลือกสำหรับวิเคราะห์
  - isSelected (boolean, session state) - ติดตามว่าเลือกในการเล่นปัจจุบันหรือไม่
  - choiceIcon (string, nullable) - อ้างอิงไอคอนภาพ
  - sortOrder (integer) - ลำดับการแสดงในบรรดาตัวเลือก
- **Computed Attributes**:
  - selectionRate (percentage) - ความถี่ที่เลือกตัวเลือกนี้
  - averageTimeToSelect (duration) - สถิติเวลาตัดสินใจ
  - conversionRate (percentage) - ผู้ใช้ที่เลือกเทียบกับดู
  - revenueGenerated (integer) - เครดิตที่ใช้ทั้งหมด
- **Relationships**:
  - Many-to-One: Scene (source and destination)
  - Many-to-One: Achievement (requirement)
- **Visibility Rules**: ข้อความตัวเลือกมองเห็นได้เสมอ; ค่าใช้จ่ายและข้อกำหนดมองเห็นตามสถานะผู้ใช้
- **Invariants**:
  - ค่าใช้จ่ายเครดิตต้องไม่เป็นลบ
  - ไม่สามารถสร้างวงจรในกราฟเรื่อง
  - ฉากปลายทางต้องเป็นของเรื่องเดียวกัน
- **Lifecycle**: Created → Validated → Active → Archived

## Entity: Asset (สื่อ)
- **Description**: ไฟล์มัลติมีเดีย (รูปภาพ, วิดีโอ, เสียง) ที่ใช้ในเรื่องและฉาก
- **Primary Identifier**: assetId (UUID)
- **Attributes**:
  - fileName (string) - ชื่อไฟล์ต้นฉบับ
  - storageUrl (string) - ตำแหน่งจัดเก็บ CDN
  - mimeType (string) - ประเภทไฟล์
  - fileSize (integer) - ขนาดไฟล์ในไบต์
  - assetType (enum) - หมวดหมู่สื่อ (image, video, audio)
  - uploadedBy (UUID, foreign key) - ID ผู้อัปโหลด
  - uploadDate (datetime) - วันที่อัปโหลด
  - isOptimized (boolean) - สถานะการปรับแต่ง
  - metadata (json) - ข้อมูลเมตาเฉพาะไฟล์ (มิติ, ระยะเวลา)
  - tags (array of strings) - แท็กค้นหาและจำแนกหมวดหมู่
  - copyright (string, nullable) - ข้อมูลลิขสิทธิ์
  - license (enum) - ประเภทใบอนุญาตการใช้งาน
  - isPublic (boolean) - ใช้งานได้สำหรับผู้สร้างทุกคน
  - thumbnailUrl (string, nullable) - ภาพขนาดย่อที่สร้าง
  - compressionLevel (integer) - การบีบอัดที่ใช้
- **Computed Attributes**:
  - usageCount (integer) - จำนวนเรื่องที่ใช้สื่อนี้
  - performanceScore (decimal) - ตัวชี้วัดเวลาโหลดและคุณภาพ
  - lastAccessed (datetime) - การใช้งานล่าสุด
  - storageCost (decimal) - ต้นทุนการจัดเก็บ CDN
- **Relationships**:
  - Many-to-One: User (uploader)
  - Many-to-Many: Story, Scene
- **Visibility Rules**: ห้องสมุดสื่อมองเห็นได้สำหรับผู้ดูแลระบบและผู้สร้างเนื้อหา; สถิติการใช้งานเฉพาะผู้ดูแลระบบ
- **Invariants**:
  - ไฟล์ต้องเป็นรูปแบบสื่อที่ถูกต้อง
  - ขนาดภายในขีดจำกัดแพลตฟอร์ม
  - ต้องมีข้อมูลลิขสิทธิ์สำหรับสื่อสาธารณะ
- **Lifecycle**: Uploaded → Processing → Optimized → Active → Archived

## Entity: CreditWallet (กระเป๋าเครดิต)
- **Description**: ยอดเงินเครดิตและประวัติธุรกรรมของผู้ใช้
- **Primary Identifier**: walletId (UUID)
- **Attributes**:
  - userId (UUID, foreign key, nullable) - เจ้าของ (null สำหรับผู้มาเยือน)
  - guestSessionId (UUID, foreign key, nullable) - เซสชันผู้มาเยือน (null สำหรับผู้สมัครสมาชิก)
  - currentBalance (integer) - จำนวนเครดิตปัจจุบัน
  - maxBalance (integer) - ความจุเครดิตสูงสุด
  - lastRefillDate (datetime) - การเติมเต็มอัตโนมัติครั้งล่าสุด
  - refillAmount (integer) - เครดิตที่เพิ่มต่อการเติมเต็ม
  - refillInterval (integer, minutes) - นาทีระหว่างการเติมเต็ม
  - totalEarned (integer) - เครดิตที่ได้รับตลอดชีวิต
  - totalSpent (integer) - เครดิตที่ใช้ไปตลอดชีวิต
  - lastTransactionDate (datetime) - ธุรกรรมล่าสุด
- **Computed Attributes**:
  - timeToNextRefill (duration) - เวลาจนถึงการเติมเต็มอัตโนมัติครั้งถัดไป
  - refillRate (decimal) - เครดิตต่อชั่วโมง
  - averageDailySpending (decimal) - การวิเคราะห์รูปแบบการใช้จ่าย
  - purchaseFrequency (decimal) - พฤติกรรมการซื้อเครดิต
- **Relationships**:
  - One-to-One: User or GuestUser
  - One-to-Many: CreditTransaction
- **Visibility Rules**: ยอดเงินมองเห็นได้สำหรับเจ้าของ; ประวัติธุรกรรมผู้ดูแลระบบสามารถเข้าถึงได้
- **Invariants**:
  - ยอดเงินไม่สามารถเกิน maxBalance
  - ไม่สามารถเป็นลบได้
  - การเติมเต็มต้องเคารพช่วงเวลาที่กำหนดค่า
- **Lifecycle**: Created → Active → Frozen → Deleted

## Entity: CreditTransaction (ธุรกรรมเครดิต)
- **Description**: การเคลื่อนไหวเครดิตแต่ละครั้งพร้อมการติดตามแหล่งที่มาและวัตถุประสงค์
- **Primary Identifier**: transactionId (UUID)
- **Attributes**:
  - walletId (UUID, foreign key) - กระเป๋าเงินที่เกี่ยวข้อง
  - amount (integer) - จำนวนเครดิต (บวกสำหรับได้รับ, ลบสำหรับใช้)
  - transactionType (enum) - หมวดหมู่ธุรกรรม (choice, refill, reward, purchase, refund, admin_adjustment)
  - sourceId (UUID, nullable) - เอนทิตีที่เกี่ยวข้อง (story, choice, achievement)
  - description (string) - คำอธิบายธุรกรรม
  - timestamp (datetime) - เวลาธุรกรรม
  - balanceBefore (integer) - ยอดเงินกระเป๋าก่อนธุรกรรม
  - balanceAfter (integer) - ยอดเงินกระเป๋าหลังธุรกรรม
  - referenceId (string, nullable) - อ้างอิงภายนอก (ID การชำระเงิน)
  - isReversible (boolean) - สามารถคืนเงินได้
  - metadata (json) - ข้อมูลธุรกรรมเพิ่มเติม
- **Computed Attributes**:
  - runningBalance (integer) - ยอดเงินสะสมเมื่อเวลาผ่านไป
  - transactionVelocity (decimal) - ความถี่ธุรกรรม
- **Relationships**:
  - Many-to-One: CreditWallet
- **Visibility Rules**: ธุรกรรมทั้งหมดมองเห็นได้สำหรับเจ้าของบัญชี; วิเคราะห์เฉพาะผู้ดูแลระบบ
- **Invariants**:
  - จำนวนต้องสมดุลถูกต้อง (หลัง - ก่อน = จำนวน)
  - ไม่สามารถสร้างยอดเงินติดลบได้
  - ไม่เปลี่ยนแปลงได้เมื่อสร้างแล้ว
- **Lifecycle**: Pending → Confirmed → Reverted (if applicable)

## Entity: Achievement (ความสำเร็จ)
- **Description**: ไมล์สโตนความสำเร็จที่ปลดล็อกเนื้อหาและให้รางวัล
- **Primary Identifier**: achievementId (UUID)
- **Attributes**:
  - name (string, 100 chars) - ชื่อความสำเร็จ
  - description (text) - คำอธิบายความสำเร็จ
  - iconUrl (string) - รูปภาพไอคอนความสำเร็จ
  - category (enum) - ประเภทความสำเร็จ (completion, exploration, social, special, hidden)
  - rarity (enum) - ความหายากของความสำเร็จ (common, uncommon, rare, epic, legendary)
  - isHidden (boolean) - ซ่อนจนกว่าจะปลดล็อก
  - creditReward (integer) - เครดิตที่ได้รับเมื่อปลดล็อก
  - avatarRewardId (UUID, foreign key, nullable) - อวาตาร์ที่ปลดล็อก
  - unlockCondition (json) - นิยามเงื่อนไข
  - points (integer) - ค่าคะแนนความสำเร็จ
  - creationDate (datetime) - วันที่สร้างความสำเร็จ
  - sortOrder (integer) - ลำดับการแสดงในหมวดหมู่
  - isActive (boolean) - มีให้ใช้งานในปัจจุบัน
  - prerequisiteAchievementIds (array) - ความสำเร็จที่จำเป็นต้องมีก่อน
- **Computed Attributes**:
  - unlockRate (percentage) - ผู้ใช้ที่ปลดล็อกแล้ว
  - averageTimeToUnlock (duration) - เวลาที่ใช้ในการได้ความสำเร็จ
  - difficultyScore (decimal) - ความยากที่คำนวณ
- **Relationships**:
  - Many-to-Many: User (through UserAchievement)
  - One-to-Many: UserAchievement
  - One-to-One: Avatar (as reward)
- **Visibility Rules**: ความสำเร็จที่ซ่อนมองไม่เห็นจนกว่าจะปลดล็อก; มุมมองการจัดการเฉพาะผู้ดูแลระบบ
- **Invariants**:
  - รางวัลเครดิตต้องไม่เป็นลบ
  - เงื่อนไขการปลดล็อกต้องถูกต้องและทดสอบได้
  - ห่วงโซ่ข้อกำหนดต้องไม่เป็นวงจร
- **Lifecycle**: Draft → Active → Retired

## Entity: UserAchievement (ความสำเร็จผู้ใช้)
- **Description**: เอนทิตีจุดเชื่อมต่อที่ติดตามความสำเร็จที่ปลดล็อกของผู้ใช้และความคืบหน้า
- **Primary Identifier**: userAchievementId (UUID)
- **Attributes**:
  - userId (UUID, foreign key) - ผู้ใช้ที่ได้ความสำเร็จ
  - achievementId (UUID, foreign key) - ความสำเร็จที่ปลดล็อก
  - unlockDate (datetime) - วันที่ได้ความสำเร็จ
  - progressPercentage (integer) - ความคืบหน้าสู่การปลดล็อก (0-100)
  - progressData (json) - ตัวชี้วัดความคืบหน้าเฉพาะ
  - isNotified (boolean) - แจ้งผู้ใช้เกี่ยวกับการปลดล็อกแล้ว
  - storyContext (json, nullable) - บริบทการปลดล็อกเฉพาะเรื่อง
- **Computed Attributes**:
  - daysSinceUnlock (integer) - เวลานับจากการได้ความสำเร็จ
  - usageCount (integer) - จำนวนครั้งที่ใช้ประโยชน์จากความสำเร็จ
- **Relationships**:
  - Many-to-One: User, Achievement
- **Visibility Rules**: สถานะความสำเร็จมองเห็นได้สำหรับเจ้าของ; ความคืบหน้ามองเห็นในโปรไฟล์
- **Invariants**:
  - เปอร์เซ็นต์ความคืบหน้าต้องอยู่ระหว่าง 0-100
  - ไม่สามารถปลดล็อกความสำเร็จเดียวกันสองครั้ง
- **Lifecycle**: Progress → Unlocked → Notified

## Entity: Avatar (อวาตาร์)
- **Description**: การปรับแต่งรูปโปรไฟล์ที่สามารถปลดล็อกผ่านความสำเร็จ
- **Primary Identifier**: avatarId (UUID)
- **Attributes**:
  - name (string, 50 chars) - ชื่อที่แสดงของอวาตาร์
  - imageUrl (string) - URL รูปภาพอวาตาร์
  - thumbnailUrl (string) - URL ตัวอย่างขนาดเล็ก
  - unlockRequirement (json) - วิธีการปลดล็อกอวาตาร์
  - rarity (enum) - ความหายากของอวาตาร์ (common, rare, epic, legendary)
  - category (enum) - ประเภทอวาตาร์ (character, object, symbol, special)
  - isActive (boolean) - มีให้ใช้งานในปัจจุบัน
  - sortOrder (integer) - ลำดับการแสดง
  - unlockDate (datetime, nullable) - วันที่อวาตาร์พร้อมใช้งาน
- **Computed Attributes**:
  - unlockRate (percentage) - ผู้ใช้ที่ปลดล็อกแล้ว
  - usageRate (percentage) - ผู้ใช้ที่ใช้อยู่ในปัจจุบัน
- **Relationships**:
  - Many-to-Many: User (through unlocked avatars)
  - One-to-One: Achievement (as reward)
- **Visibility Rules**: อวาตาร์ที่ถูกล็อกแสดงเป็นเงาพร้อมคำแนะนำการปลดล็อก
- **Invariants**:
  - ต้องมี URL รูปภาพที่ถูกต้อง
  - ข้อกำหนดการปลดล็อกต้องสามารถทำได้
- **Lifecycle**: Locked → Unlocked → Equipped

## Entity: StoryProgress (ความคืบหน้าเรื่อง)
- **Description**: ความคืบหน้าของผู้ใช้ในเรื่องเฉพาะพร้อมการติดตามเส้นทาง
- **Primary Identifier**: progressId (UUID)
- **Attributes**:
  - userId (UUID, foreign key, nullable) - ผู้ใช้ (null สำหรับผู้มาเยือน)
  - guestSessionId (UUID, foreign key, nullable) - เซสชันผู้มาเยี่ยม
  - storyId (UUID, foreign key) - เรื่องที่กำลังเล่น
  - currentSceneId (UUID, foreign key) - ตำแหน่งปัจจุบัน
  - pathTaken (array of UUIDs) - ลำดับฉากที่เยี่ยมชม
  - choicesMade (array of UUIDs) - ตัวเลือกที่เลือก
  - startTime (datetime) - เวลาเริ่มเซสชัน
  - lastActivityTime (datetime) - การโต้ตอบครั้งล่าสุด
  - timeSpent (duration) - เวลาทั้งหมดในเรื่อง
  - creditsSpent (integer) - เครดิตที่ใช้ในเซสชัน
  - isCompleted (boolean) - เรื่องจบแล้ว
  - completionDate (datetime, nullable) - วันที่จบเรื่อง
  - endingType (enum, nullable) - ประเภทจุดสิ้นสุดที่ถึง
  - completionPercentage (integer) - เปอร์เซ็นต์การสำรวจเรื่อง
  - bookmarkData (json) - ข้อมูลสถานะที่บันทึก
  - attemptNumber (integer) - ความพยายามครั้งที่เท่าไร
- **Computed Attributes**:
  - completionRate (percentage) - ส่วนของเรื่องที่สำรวจ
  - averageTimePerScene (duration) - การวิเคราะห์จังหวะ
  - creditEfficiency (decimal) - เครดิตที่ใช้ต่อฉาก
- **Relationships**:
  - Many-to-One: User or GuestUser, Story, Scene (current)
- **Visibility Rules**: ความคืบหน้ามองเห็นได้สำหรับเจ้าของ; สถิติรวมเฉพาะผู้ดูแลระบบ
- **Invariants**:
  - ไม่สามารถมีทั้ง userId และ guestSessionId
  - เส้นทางต้องเป็นลำดับที่ถูกต้องจากจุดเริ่มเรื่อง
- **Lifecycle**: Started → InProgress → Completed → Archived

## Entity: Rating (การจัดอันดับ)
- **Description**: การจัดอันดับดาวของผู้ใช้สำหรับเรื่องที่จบแล้ว
- **Primary Identifier**: ratingId (UUID)
- **Attributes**:
  - userId (UUID, foreign key, nullable) - ผู้จัดอันดับ (null สำหรับผู้มาเยี่ยม)
  - guestSessionId (UUID, foreign key, nullable) - เซสชันผู้มาเยี่ยม
  - storyId (UUID, foreign key) - เรื่องที่จัดอันดับ
  - starRating (integer, 1-5) - ค่าการจัดอันดับดาว
  - ratingDate (datetime) - วันที่ให้คะแนน
  - isModified (boolean) - การจัดอันดับถูกแก้ไข
  - lastModifiedDate (datetime) - การแก้ไขครั้งล่าสุด
  - previousRating (integer, nullable) - ค่าดาวก่อนหน้าหากแก้ไข
  - contextData (json) - บริบทการจัดอันดับ (ประเภทจุดสิ้นสุด, เส้นทางที่เลือก)
- **Computed Attributes**:
  - ratingWeight (decimal) - ตัวประกอบอิทธิพลการจัดอันดับ
  - ratingAge (duration) - เวลานับจากการจัดอันดับ
- **Relationships**:
  - Many-to-One: User or GuestUser, Story
- **Visibility Rules**: การจัดอันดับมองเห็นได้ในรายละเอียดเรื่อง; ตัวตนผู้ใช้ไม่ระบุชื่อ
- **Invariants**:
  - การจัดอันดับดาวต้องอยู่ระหว่าง 1-5
  - ไม่สามารถมีทั้ง userId และ guestSessionId
  - ไม่สามารถจัดอันดับเรื่องที่ยังไม่จบ
- **Lifecycle**: Created → Modified (optional) → Archived

## Entity: Review (รีวิว)
- **Description**: รีวิวข้อความโดยละเอียดพร้อมการจัดอันดับดาวตามตัวเลือก
- **Primary Identifier**: reviewId (UUID)
- **Attributes**:
  - userId (UUID, foreign key, nullable) - ผู้รีวิว (null สำหรับผู้มาเยี่ยม)
  - guestSessionId (UUID, foreign key, nullable) - เซสชันผู้มาเยี่ยม
  - storyId (UUID, foreign key) - เรื่องที่รีวิว
  - ratingId (UUID, foreign key, nullable) - การจัดอันดับที่เกี่ยวข้อง
  - reviewText (text, 500 chars) - เนื้อหารีวิว
  - reviewDate (datetime) - วันที่ส่งรีวิว
  - isModified (boolean) - รีวิวถูกแก้ไข
  - lastModifiedDate (datetime) - การแก้ไขครั้งล่าสุด
  - moderatorId (UUID, foreign key, nullable) - ผู้ดูแลที่ตรวจสอบ
  - moderationStatus (enum) - สถานะรีวิว (pending, approved, rejected, flagged)
  - moderationDate (datetime, nullable) - วันที่ตรวจสอบ
  - moderatorNotes (text, nullable) - เหตุผลการตรวจสอบ
  - isPublic (boolean) - สถานะการมองเห็น
  - helpfulVotes (integer) - โหวตที่เป็นประโยชน์ของชุมชน
  - reportCount (integer) - จำนวนครั้งที่รายงาน
  - adminReply (text, nullable) - การตอบกลับของผู้ดูแลระบบ
  - adminReplyDate (datetime, nullable) - วันที่ผู้ดูแลระบบตอบกลับ
- **Computed Attributes**:
  - reviewAge (duration) - เวลานับจากรีวิว
  - engagementScore (decimal) - ตัวชี้วัดการโต้ตอบของชุมชน
- **Relationships**:
  - Many-to-One: User or GuestUser, Story, Rating, User (moderator)
- **Visibility Rules**: รีวิวที่อนุมัติสาธารณะ; ที่รอดูมองเห็นได้เฉพาะผู้รีวิวและผู้ดูแลระบบ
- **Invariants**:
  - ข้อความรีวิวต้องไม่ว่างเปล่า
  - ไม่สามารถมีทั้ง userId และ guestSessionId
  - ต้องจบเรื่องเพื่อรีวิว
- **Lifecycle**: Draft → Submitted → Moderated → Published/Rejected

## Entity: AdminUser (ผู้ดูแลระบบ)
- **Description**: ผู้ใช้ผู้ดูแลระบบที่มีสิทธิ์พิเศษและระดับการเข้าถึง
- **Primary Identifier**: adminId (UUID)
- **Attributes**:
  - userId (UUID, foreign key, nullable) - บัญชีผู้ใช้ที่เชื่อมโยง
  - email (string, unique) - อีเมลผู้ดูแลระบบ
  - role (enum) - บทบาทผู้ดูแลระบบ (super_admin, content_director, story_editor, community_manager, data_analyst)
  - permissions (array) - ชุดสิทธิ์เฉพาะ
  - isActive (boolean) - สถานะผู้ดูแลระบบ
  - lastLoginDate (datetime) - เซสชันผู้ดูแลระบบครั้งล่าสุด
  - loginCount (integer) - การเข้าสู่ระบบผู้ดูแลระบบทั้งหมด
  - sessionTimeout (duration) - เวลาออโต้ล็อกเอาท์
  - allowedIpRanges (array) - ข้อจำกัดการเข้าถึง IP
  - twoFactorEnabled (boolean) - สถานะ 2FA
  - passwordLastChanged (datetime) - การติดตามความปลอดภัย
  - department (string) - แผนกองค์กร
  - accessLevel (integer) - ระดับสิทธิ์ (1-10)
- **Computed Attributes**:
  - riskScore (decimal) - การประเมินความเสี่ยงความปลอดภัย
  - activityLevel (decimal) - รูปแบบการใช้งาน
- **Relationships**:
  - One-to-One: User (optional)
  - One-to-Many: ModerationAction, SystemLog
- **Visibility Rules**: ตัวตนผู้ดูแลระบบมองเห็นได้เฉพาะผู้ดูแลระบบอื่นเท่านั้น
- **Invariants**:
  - บทบาทต้องมีสิทธิ์ที่เหมาะสม
  - ต้องมี 2FA สำหรับบทบาทที่มีสิทธิ์สูง
- **Lifecycle**: Created → Active → Suspended → Deactivated

## Entity: ModerationAction (การกระทำการตรวจสอบ)
- **Description**: บันทึกการกระทำการตรวจสอบของผู้ดูแลระบบบนเนื้อหา
- **Primary Identifier**: actionId (UUID)
- **Attributes**:
  - adminId (UUID, foreign key) - ผู้ดูแลระบบที่ดำเนินการ
  - actionType (enum) - หมวดหมู่การกระทำ (approve, reject, flag, edit, delete, ban)
  - targetType (enum) - ประเภทเป้าหมาย (review, story, user, asset)
  - targetId (UUID) - ID เอนทิตีเป้าหมาย
  - reason (string) - เหตุผลการกระทำ
  - notes (text) - โน้ตโดยละเอียด
  - actionDate (datetime) - วันที่เกิดการกระทำ
  - previousState (json) - สถานะก่อนการกระทำ
  - newState (json) - สถานะหลังการกระทำ
  - isPermanent (boolean) - การถาวรของการกระทำ
  - expiryDate (datetime, nullable) - การหมดอายุการกระทำชั่วคราว
  - automaticAction (boolean) - การกระทำที่เริ่มโดยระบบ
  - appealStatus (enum, nullable) - สถานะอุทธรณ์ (pending, approved, denied)
- **Computed Attributes**:
  - actionAge (duration) - เวลานับจากการกระทำ
  - appealResponseTime (duration) - เวลาประมวลผลอุทธรณ์
- **Relationships**:
  - Many-to-One: AdminUser
- **Visibility Rules**: บันทึกการกระทำมองเห็นได้สำหรับผู้ดูแลระบบตามบทบาท
- **Invariants**:
  - การกระทำต้องได้รับอนุญาตสำหรับบทบาทผู้ดูแลระบบ
  - เป้าหมายต้องมีอยู่
- **Lifecycle**: Initiated → Executed → Appealed (optional) → Resolved