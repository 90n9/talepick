# Domain Model Specification (Stage 2) - Part 6: Business Rules

## 6. DOMAIN RULES (Business Rules)

### Story Rules (กฎเรื่อง)
- **Rule**: เรื่องต้องมีฉากจุดเริ่มต้นอย่างน้อยหนึ่งฉาก
  - **Condition**: การสร้างหรือแก้ไขเรื่อง
  - **Expected**: ระบบตรวจสอบและบังคับข้อกำหนดฉากเริ่มต้น
  - **Constraints**: ไม่สามารถเผยแพร่โดยไม่มีฉากเริ่มต้น
  - **Exceptions**: ไม่มี

- **Rule**: เรื่องที่เผยแพร่ไม่สามารถมีฉากที่เข้าถึงไม่ได้
  - **Condition**: การเปลี่ยนสถานะเรื่องเป็นเผยแพร่
  - **Expected**: ระบบตรวจสอบฉากทั้งหมดเข้าถึงได้จากจุดเริ่มต้น
  - **Constraints**: บล็อกการเผยแพร่หากมีฉากที่เข้าถึงไม่ได้
  - **Exceptions**: การแทนที่ของผู้ดูแลระบบด้วยการอนุมัติโดยชัดแจ้ง

- **Rule**: เรื่องไม่สามารถมีวงจรไม่สิ้นสุดในเส้นทางตัวเลือก
  - **Condition**: การสร้างตัวเลือกหรือการตรวจสอบเรื่อง
  - **Expected**: ระบบตรวจจับวงจรและป้องกันการสร้าง
  - **Constraints**: บังคับใช้ความยาวเส้นทางสูงสุด
  - **Exceptions**: วงจรที่สร้างโดยผู้ดูแลระบบโดยตั้งใจพร้อมเครื่องหมายพิเศษ

- **Rule**: ชื่อเรื่องและคำอธิบายจำเป็นสำหรับการเผยแพร่
  - **Condition**: การเผยแพร่เวิร์กโฟลว์
  - **Expected**: ระบบตรวจสอบการมีอยู่และข้อจำกัดความยาว
  - **Constraints**: ชื่อ 10-100 ตัวอักษร คำอธิบาย 50-1000 ตัวอักษร
  - **Exceptions**: ไม่มี

### Scene / Branching Rules (กฎฉาก/การแยกเส้นทาง)
- **Rule**: ฉากที่ไม่ใช่จุดสิ้นสุดต้องมีตัวเลือกขาออกอย่างน้อยหนึ่งตัว
  - **Condition**: การสร้างหรือแก้ไขฉาก
  - **Expected**: ระบบบังคับใช้ข้อกำหนดตัวเลือก
  - **Constraints**: ตัวเลือกขั้นต่ำหนึ่งตัว สูงสุดสิบตัว
  - **Exceptions**: ไม่มี

- **Rule**: การเปลี่ยนฉากต้องเคารพโครงสร้างเรื่อง
  - **Condition**: การกำหนดปลายทางตัวเลือก
  - **Expected**: ระบบตรวจสอบว่าปลายทางเป็นของเรื่องเดียวกัน
  - **Constraints**: ไม่สามารถเชื่อมต่อฉากจากเรื่องต่างกัน
  - **Exceptions**: การเชื่อมต่อข้ามเรื่องของผู้ดูแลระบบสำหรับฟีเจอร์พิเศษ

- **Rule**: ส่วนข้อความฉากต้องมีการจับเวลาที่ถูกต้อง
  - **Condition**: การสร้างส่วนข้อความ
  - **Expected**: ระบบตรวจสอบความสอดคล้องของข้อมูลเวลา
  - **Constraints**: ระยะเวลาบวก ส่วนไม่ทับซ้อนกัน
  - **Exceptions**: การแทนที่ด้วยตนสำหรับเนื้อหาผู้ดูแลระบบ

### Choice Rules (กฎตัวเลือก)
- **Rule**: ต้นทุนตัวเลือกต้องเป็นจำนวนเต็มไม่เป็นลบ
  - **Condition**: การสร้างหรือแก้ไขตัวเลือก
  - **Expected**: ระบบตรวจสอบข้อจำกัดต้นทุน
  - **Constraints**: 0 ≤ ต้นทุน ≤ ยอดเงินปัจจุบันของผู้ใช้
  - **Exceptions**: ต้นทุนลบที่สร้างโดยผู้ดูแลระบบ (การคืนเงิน)

- **Rule**: ตัวเลือกที่มีข้อกำหนดความสำเร็จตรวจสอบความเป็นเจ้าของของผู้ใช้
  - **Condition**: การเลือกตัวเลือกระหว่างการเล่น
  - **Expected**: ระบบตรวจสอบว่าผู้ใช้มีความสำเร็จที่จำเป็น
  - **Constraints**: ปิดใช้งานตัวเลือกหากไม่เป็นไปตามข้อกำหนด
  - **Exceptions**: โหมดทดสอบของผู้ดูแลระบบข้ามข้อกำหนด

- **Rule**: ตัวเลือกพิเศษต้องมีเนื้อหาพรีเมียม
  - **Condition**: การทำเครื่องหมายตัวเลือกเป็นพิเศษ
  - **Expected**: ระบบตรวจสอบเนื้อหาหรือผลลัพธ์ที่ดีขึ้น
  - **Constraints**: ต้องมีต้นทุนเครดิต > 0 หรือข้อกำหนดความสำเร็จ
  - **Exceptions**: ตัวเลือกสอนที่ทำเครื่องหมายเป็นพิเศษสำหรับการเรียนรู้

### Credit System Rules (กฎระบบเครดิต)
- **Rule**: เครดิตไม่สามารถเกินความจุกระเป๋าเงินสูงสุด
  - **Condition**: การเพิ่มเครดิต (เติมเต็ม, ซื้อ, รางวัล)
  - **Expected**: ระบบจำกัดที่สูงสุด ส่วนเกินทิ้ง
  - **Constraints**: 50 สำหรับผู้มาเยี่ยม 200 สำหรับผู้สมัครสมาชิก
  - **Exceptions**: เครดิตโบนัสของผู้ดูแลระบบเหนือขีดจำกัด

- **Rule**: การเติมเต็มอัตโนมัติเกิดขึ้นตามช่วงเวลาที่กำหนดค่า
  - **Condition**: เหตุการณ์ระบบตามเวลา
  - **Expected**: ระบบเพิ่มจำนวนที่กำหนดค่าในกระเป๋าเงิน
  - **Constraints**: ทุก 5 นาที สูงสุด 20 เครดิต
  - **Exceptions**: หยุดเติมเต็มระหว่างการระงับ

- **Rule**: ธุรกรรมเครดิตต้องส่งผลให้ยอดเงินถูกต้องเสมอ
  - **Condition**: การเคลื่อนไหวเครดิตใดๆ
  - **Expected**: ระบบตรวจสอบความสอดคล้องยอดเงินก่อน/หลัง
  - **Constraints**: ยอดเงินต้องคง ≥ 0
  - **Exceptions**: การปรับเปลี่ยนของผู้ดูแลระบบพร้อมเหตุผล

- **Rule**: เครดิตไม่เพียงพอบล็อกการเลือกตัวเลือก
  - **Condition**: ผู้ใช้เลือกตัวเลือกที่ต้นทุน > ยอดเงิน
  - **Expected**: ระบบป้องกันการเลือกและแสดงพร้อมท์
  - **Constraints**: ไม่สามารถมียอดเงินติดลบได้
  - **Exceptions**: รหัสแทนที่ฉุกเฉินของผู้ดูแลระบบ

### Rating Rules (กฎการจัดอันดับ)
- **Rule**: เฉพาะเรื่องที่จบแล้วที่สามารถจัดอันดับได้
  - **Condition**: การส่งการจัดอันดับ
  - **Expected**: ระบบตรวจสอบสถานะการจบเรื่อง
  - **Constraints**: ต้องถึงฉากจุดสิ้นสุด
  - **Exceptions**: โหมดพรีวิวของผู้ดูแลระบบ

- **Rule**: หนึ่งการจัดอันดับต่อผู้ใช้ต่อเรื่อง
  - **Condition**: การส่งการจัดอันดับ
  - **Expected**: ระบบตรวจสอบการจัดอันดับที่มีอยู่
  - **Constraints**: อนุญาตการอัปเดต ป้องกันการซ้ำ
  - **Exceptions**: ไม่มี

- **Rule**: การจัดอันดับดาวต้องอยู่ระหว่าง 1-5
  - **Condition**: การสร้างหรืออัปเดตการจัดอันดับ
  - **Expected**: ระบบตรวจสอบช่วงการจัดอันดับ
  - **Constraints**: ค่าจำนวนเต็มเท่านั้น
  - **Exceptions**: ไม่มี

### Achievement Rules (กฎความสำเร็จ)
- **Rule**: ความสำเร็จปลดล็อกเมื่อเงื่อนไขเป็นไปตามนั้นเท่านั้น
  - **Condition**: การอัปเดตความคืบหน้าความสำเร็จ
  - **Expected**: ระบบประเมินเงื่อนไขการปลดล็อก
  - **Constraints**: เงื่อนไขต้องวัดได้โดยวัตถุประสงค์
  - **Exceptions**: การปลดล็อกด้วยตนโดยผู้ดูแลระบบสำหรับการทดสอบ

- **Rule**: ความสำเร็จที่ซ่อนยังคงมองไม่เห็นจนกว่าจะปลดล็อก
  - **Condition**: การแสดงความสำเร็จใน UI
  - **Expected**: ระบบกรองความสำเร็จที่ซ่อน
  - **Constraints**: แสดงเฉพาะชื่อและคำอธิบายหลังปลดล็อก
  - **Exceptions**: โหมดดูของผู้ดูแลระบบ

- **Rule**: ข้อกำหนดความสำเร็จต้องได้รับการตอบสนองก่อน
  - **Condition**: ความพยายามปลดล็อกความสำเร็จ
  - **Expected**: ระบบตรวจสอบห่วงโซ่ข้อกำหนด
  - **Constraints**: ข้อกำหนดทั้งหมดต้องได้รับการปลดล็อก
  - **Exceptions**: การแทนที่ของผู้ดูแลระบบพร้อมเอกสาร

### Visibility Rules (Frontend vs Admin)
- **Rule**: เรื่องฉบับร่างมองเห็นได้เฉพาะผู้เขียนและผู้ดูแลระบบ
  - **Condition**: การเรียกดูและรายการเรื่อง
  - **Expected**: ระบบกรองสถานะการเผยแพร่
  - **Constraints**: ผู้เขียนเห็นฉบับร่างของตนเอง ผู้ดูแลระบบเห็นทั้งหมด
  - **Exceptions**: สิทธิ์การแก้ไขร่วมกัน

- **Rule**: ข้อมูลส่วนตัวของผู้ใช้ซ่อนจากผู้ใช้อื่น
  - **Condition**: การดูโปรไฟล์และฟีเจอร์สังคม
  - **Expected**: ระบบกรองข้อมูลส่วนตัว
  - **Constraints**: อีเมล ยอดเงิน ประวัติซ่อน
  - **Exceptions**: ผู้ใช้ทำข้อมูลเป็นสาธารณะโดยชัดแจ้ง

- **Rule**: การกระทำของผู้ดูแลระบบบันทึกและตรวจสอบได้
  - **Condition**: การแก้ไขใดๆ ของผู้ดูแลระบบ
  - **Expected**: ระบบบันทึกรายละเอียดการกระทำ
  - **Constraints**: การประทับเวลา ID ผู้ดูแลระบบ ประเภทการกระทำ เป้าหมาย
  - **Exceptions**: การกระทำฉุกเฉินพร้อมการอนุมัติพิเศษ

### Guest User Limitations (ข้อจำกัดผู้ใช้ผู้มาเยี่ยม)
- **Rule**: เครดิตผู้มาเยี่ยมจำกัดสูงสุด 50
  - **Condition**: การสะสมเครดิตสำหรับผู้มาเยี่ยม
  - **Expected**: ระบบบังคับใช้จำกัดที่ 50
  - **Constraints**: ไม่สามารถเกินผ่านวิธีใดๆ
  - **Exceptions**: ไม่มี

- **Rule**: ความสำเร็จผู้มาเยี่ยมเฉพาะเซสชัน
  - **Condition**: การปลดล็อกความสำเร็จสำหรับผู้มาเยี่ยม
  - **Expected**: ระบบติดตามแต่ไม่เก็บรักษาความสำเร็จ
  - **Constraints**: สูญหายเมื่อเซสชันหมดอายุ
  - **Exceptions**: การแปลงความสำเร็จการลงทะเบียน

- **Rule**: ผู้มาเยี่ยมไม่สามารถจัดอันดับหรือรีวิวเรื่อง
  - **Condition**: การส่งการจัดอันดับ/รีวิว
  - **Expected**: ระบบบล็อกความพยายามผู้มาเยี่ยม
  - **Constraints**: ต้องการบัญชีที่ลงทะเบียน
  - **Exceptions**: ไม่มี

### Publishing Rules (กฎการเผยแพร่)
- **Rule**: เรื่องต้องผ่านการตรวจสอบก่อนการเผยแพร่
  - **Condition**: การเริ่มเวิร์กโฟลว์การเผยแพร่
  - **Expected**: ระบบรันการตรวจสอบอย่างละเอียด
  - **Constraints**: โครงสร้าง เนื้อหา สื่อทั้งหมดตรวจสอบ
  - **Exceptions**: การแทนที่ของผู้ดูแลระบบด้วยการอนุมัติโดยชัดแจ้ง

- **Rule**: เรื่องที่เผยแพร่ไม่สามารถลบได้
  - **Condition**: ความพยายามลบเรื่องที่เผยแพร่
  - **Expected**: ระบบป้องกันการลบ เสนอการเก็บถาวร
  - **Constraints**: เก็บรักษาข้อมูลผู้ใช้และการวิเคราะห์
  - **Exceptions**: ข้อกำหนดการลบทางกฎหมาย

- **Rule**: การตรวจสอบเนื้อหาใช้ก่อนการเผยแพร่
  - **Condition**: การส่งเรื่องสำหรับการเผยแพร่
  - **Expected**: ระบบจัดคิวสำหรับการตรวจสอบหากถูกตั้งค่าสถานะ
  - **Constraints**: การตรวจสอบอัตโนมัติ การตรวจสอบโดยมนุษย์หากจำเป็น
  - **Exceptions**: การข้ามของผู้สร้างที่เชื่อถือได้พร้อมการตรวจสอบ

### Admin Editing Rules (กฎการแก้ไขผู้ดูแลระบบ)
- **Rule**: การกำหนดเวอร์ชันเรื่องติดตามการเปลี่ยนแปลงทั้งหมด
  - **Condition**: การแก้ไขเรื่องใดๆ
  - **Expected**: ระบบเพิ่มเวอร์ชันและบันทึกการเปลี่ยนแปลง
  - **Constraints**: รักษาประวัติการเปลี่ยนแปลง
  - **Exceptions**: การแก้ไขข้อความเล็กน้อยด้วยเวอร์ชันเดียวกัน

- **Rule**: การเปลี่ยนแปลงเรื่องที่เผยแพร่ต้องการตรวจสอบใหม่
  - **Condition**: การแก้ไขเรื่องที่เผยแพร่
  - **Expected**: ระบบรันการตรวจสอบใหม่
  - **Constraints**: อาจต้องการเผยแพร่ใหม่หากเปลี่ยนแปลงใหญ่
  - **Exceptions**: การแก้ไขด่วนสำหรับปัญหาที่สำคัญ

- **Rule**: การกระทำผู้ดูแลระบบต้องการสิทธิ์ที่เหมาะสม
  - **Condition**: การดำเนินการผู้ดูแลระบบใดๆ
  - **Expected**: ระบบตรวจสอบสิทธิ์บทบาท
  - **Constraints**: แต่ละบทบาทมีการกระทำที่อนุญาตเฉพาะ
  - **Exceptions**: ขั้นตอนการยกระดับฉุกเฉิน

### Story Asset Rules (กฎสื่อเรื่อง)
- **Rule**: การปรับแต่งสื่อใช้โดยอัตโนมัติ
  - **Condition**: การอัปโหลดสื่อ
  - **Expected**: ระบบประมวลผลและปรับแต่งสื่อ
  - **Constraints**: รักษามาตรฐานคุณภาพ
  - **Exceptions**: การข้ามของผู้ดูแลระบบพร้อมเหตุผล

- **Rule**: การใช้งานสื่อติดตามข้ามเรื่องทั้งหมด
  - **Condition**: การกำหนดสื่อให้ฉาก/เรื่อง
  - **Expected**: ระบบรักษาการอ้างอิงการใช้งาน
  - **Constraints**: ป้องกันการลบสื่อที่ใช้อยู่
  - **Exceptions**: การลบบังคับพร้อมคำเตือน

- **Rule**: ข้อมูลลิขสิทธิ์จำเป็นสำหรับสื่อสาธารณะ
  - **Condition**: การทำเครื่องหมายสื่อเป็นสาธารณะ
  - **Expected**: ระบบตรวจสอบข้อมูลเมตาลิขสิทธิ์
  - **Constraints**: ต้องมีข้อมูลใบอนุญาต
  - **Exceptions**: สื่อที่เป็นของแพลตฟอร์ม